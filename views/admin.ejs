<%- include('layout.ejs') %>

<!-- ƒêƒÉng xu·∫•t -->
<div class="w-full flex justify-end px-4 py-2">
  <form action="/logout" method="POST">
    <button type="submit"
      class="bg-red-500 hover:bg-red-600 text-white text-xs sm:text-sm px-3 py-1 sm:px-4 sm:py-2 rounded-lg font-medium transition">
      üîì ƒêƒÉng xu·∫•t
    </button>
  </form>
</div>

<!-- Khung ch√≠nh -->
<div class="bg-gray-100 min-h-screen py-8 px-4">
  <div class="max-w-6xl mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-xl space-y-10">

    <!-- Ti√™u ƒë·ªÅ v√† th√¥ng b√°o -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <h2 class="text-2xl sm:text-3xl font-bold text-gray-800">üìä Admin Dashboard</h2>
    </div>

    <% if (message) { %>
      <div class="text-center text-red-600 font-semibold">
        <%= message %>
      </div>
    <% } %>

    <!-- Nh·∫≠p file Excel -->
    <form action="/import" method="POST" enctype="multipart/form-data" class="space-y-4">
      <label for="excelFile" class="block text-sm font-medium text-gray-700">üì• Ch·ªçn file d·ªØ li·ªáu (.xlsx)</label>
      <input type="file" id="excelFile" name="excelFile" accept=".xlsx" required
        class="block w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500" />
      <button type="submit"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-medium transition-all">
        X√°c nh·∫≠n
      </button>
    </form>
  </div>

  <!-- B·ªô l·ªçc v√† k·∫øt qu·∫£ -->
  <div class="max-w-6xl mx-auto mt-10 space-y-6">
    <!-- B·ªô l·ªçc -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 bg-white p-4 rounded-xl shadow">
      <div>
        <label class="font-semibold">Th√°ng</label>
        <select id="month" onchange="updateBatchesAndSalary()" class="w-full border p-2 rounded">
          <% for(let m=1; m <=12; m++) { %>
            <option value="<%= m %>"><%= m %></option>
          <% } %>
        </select>
      </div>
      <div>
        <label class="font-semibold">NƒÉm</label>
        <select id="year" onchange="updateBatchesAndSalary()" class="w-full border p-2 rounded">
          <% const thisYear = new Date().getFullYear(); %>
          <% for(let y = thisYear; y >= thisYear - 5; y--) { %>
            <option value="<%= y %>"><%= y %></option>
          <% } %>
        </select>
      </div>
      <div>
        <label class="font-semibold">ƒê·ª£t</label>
        <select id="batch" onchange="updateSalary()" class="w-full border p-2 rounded">
          <option value="">--</option>
        </select>
      </div>
    </div>

    <!-- K·∫øt qu·∫£ b·∫£ng l∆∞∆°ng -->
    <div id="salary-result" class="bg-white p-4 rounded-xl shadow overflow-x-auto"></div>
  </div>
</div>

<script>
  async function updateBatchesAndSalary() {
    const month = document.getElementById('month').value;
    const year = document.getElementById('year').value;
    const batchSelect = document.getElementById('batch');

    if (!month || !year) return;

    const res = await fetch(`/admin/pay-periods?month=${month}&year=${year}`);
    const data = await res.json();

    batchSelect.innerHTML = '<option value="">--</option>';
    data.forEach(b => {
      const opt = document.createElement('option');
      opt.value = b;
      opt.textContent = `ƒê·ª£t ${b}`;
      batchSelect.appendChild(opt);
    });

    updateSalary();
  }

  async function updateSalary() {
    const month = document.getElementById('month').value;
    const year = document.getElementById('year').value;
    const batch = document.getElementById('batch').value;

    if (!month || !year || !batch) {
      document.getElementById('salary-result').innerHTML = '';
      return;
    }

    const res = await fetch(`/admin/salary?month=${month}&year=${year}&batch=${batch}`);
    const data = await res.json();
    const salaries = data.salary || [];

    if (salaries.length === 0) {
      document.getElementById('salary-result').innerHTML = `<div class="text-red-500">Kh√¥ng c√≥ d·ªØ li·ªáu b·∫£ng l∆∞∆°ng</div>`;
      return;
    }

    let html = `
    <div class="flex justify-between items-center mb-4">
  <h3 class="text-lg sm:text-xl font-bold text-gray-800">B·∫£ng l∆∞∆°ng th√°ng ${month}, ƒë·ª£t ${batch}, nƒÉm ${year}</h3>
  <form action="/admin/delete-salary" method="POST" onsubmit="return confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a b·∫£ng l∆∞∆°ng ƒë·ª£t n√†y?')">
    <input type="hidden" name="month" value="${month}">
    <input type="hidden" name="year" value="${year}">
    <input type="hidden" name="batch" value="${batch}">
    <button type="submit"
      class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
      üóëÔ∏è X√≥a ƒë·ª£t
    </button>
  </form>
</div>
    <table class="w-full table-auto border-collapse bg-white text-sm min-w-[1000px]">
      <thead>
        <tr class="bg-gray-100 text-gray-700 uppercase tracking-wide text-xs">
          <th class="px-4 py-3 text-left">H·ªç v√† t√™n</th>
          <th class="px-4 py-3 text-left">Hoa h·ªìng</th>
          <th class="px-4 py-3 text-left">Kho·∫£n chi 1</th>
          <th class="px-4 py-3 text-left">Kho·∫£n chi 2</th>
          <th class="px-4 py-3 text-left">Kho·∫£n chi 3</th>
          <th class="px-4 py-3 text-left">Kho·∫£n chi 4</th>
          <th class="px-4 py-3 text-left">Kho·∫£n chi 5</th>
          <th class="px-4 py-3 text-left">Kho·∫£n chi 6</th>
          <th class="px-4 py-3 text-left">Truy thu hoa h·ªìng</th>
          <th class="px-4 py-3 text-left">Th∆∞·ªüng TCTy</th>
          <th class="px-4 py-3 text-left">Th∆∞·ªüng Cty</th>
          <th class="px-4 py-3 text-left">Th√π lao</th>
          <th class="px-4 py-3 text-left">Truy thu th√π lao</th>
          <th class="px-4 py-3 text-left">Th∆∞·ªüng TCTy.1</th>
          <th class="px-4 py-3 text-left">Th∆∞·ªüng Cty.1</th>
          <th class="px-4 py-3 text-left">Thu·∫ø</th>
          <th class="px-4 py-3 text-left font-bold">Th·ª±c chi</th>
        </tr>
      </thead>
      <tbody class="text-gray-700">
    `;
   
    salaries.forEach(d => {
      const s = d.salaryDetails
      html += `
        <tr class="border-t hover:bg-gray-50 transition">
          <td class="px-4 py-3">${s.name || ''}</td>
          <td class="px-4 py-3">${(s.commission || 0).toLocaleString()}</td>
          <td class="px-4 py-3">${(s.payout1 || 0).toLocaleString()}</td>
          <td class="px-4 py-3">${(s.payout2 || 0).toLocaleString()}</td>
          <td class="px-4 py-3">${(s.payout3 || 0).toLocaleString()}</td>
          <td class="px-4 py-3">${(s.payout4 || 0).toLocaleString()}</td>
          <td class="px-4 py-3">${(s.payout5 || 0).toLocaleString()}</td>
          <td class="px-4 py-3">${(s.payout6 || 0).toLocaleString()}</td>
          <td class="px-4 py-3">${(s.extracommission || 0).toLocaleString()}</td>
          <td class="px-4 py-3">${(s.ebonusTCTy || 0).toLocaleString()}</td>
          <td class="px-4 py-3">${(s.ebonusCT || 0).toLocaleString()}</td>
          <td class="px-4 py-3">${(s.compensation || 0).toLocaleString()}</td>
          <td class="px-4 py-3">${(s.extrasalary || 0).toLocaleString()}</td>
          <td class="px-4 py-3">${(s.ebonusTCTy1 || 0).toLocaleString()}</td>
          <td class="px-4 py-3">${(s.ebonusCT1 || 0).toLocaleString()}</td>
          <td class="px-4 py-3">${(s.tax || 0).toLocaleString()}</td>
          <td class="px-4 py-3 font-semibold text-green-700">${(s.actualcost || 0).toLocaleString()}</td>
        </tr>
      `;
    });

    html += `</tbody></table>`;
    document.getElementById('salary-result').innerHTML = html;
  }

  window.addEventListener('DOMContentLoaded', updateBatchesAndSalary);
</script>

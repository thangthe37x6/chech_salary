<%- include('layout.ejs') %>
  <!-- B·ªô l·ªçc t√¨m ki·∫øm -->
<div class="w-full flex justify-end px-4 py-2">
  <form action="/logout" method="POST">
    <button type="submit"
      class="bg-red-500 hover:bg-red-600 text-white text-xs sm:text-sm px-3 py-1 sm:px-4 sm:py-2 rounded-lg font-medium transition">
      üîì ƒêƒÉng xu·∫•t
    </button>
  </form>
</div>
  <div class="max-w-4xl mx-auto bg-white rounded-xl p-4 space-y-4 mt-8 border">

    <!-- H√†ng: Th√°ng / NƒÉm / ƒê·ª£t -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
      <div>
        <label class="block mb-1 font-semibold text-gray-700">Th√°ng</label>
        <select id="month" onchange="updateBatchesAndSalary()"
          class="w-full border border-gray-300 p-2 rounded focus:ring focus:ring-blue-200">
          <% for(let m=1; m <=12; m++) { %>
            <option value="<%= m %>">
              <%= m %>
            </option>
            <% } %>
        </select>
      </div>
      <div>
        <label class="block mb-1 font-semibold text-gray-700">NƒÉm</label>
        <select id="year" onchange="updateBatchesAndSalary()"
          class="w-full border border-gray-300 p-2 rounded focus:ring focus:ring-blue-200">
          <% const thisYear=new Date().getFullYear(); %>
            <% for(let y=thisYear; y>= thisYear - 5; y--) { %>
              <option value="<%= y %>">
                <%= y %>
              </option>
              <% } %>
        </select>
      </div>
      <div>
        <label class="block mb-1 font-semibold text-gray-700">ƒê·ª£t</label>
        <select id="batch" onchange="updateSalary()"
          class="w-full border border-gray-300 p-2 rounded focus:ring focus:ring-blue-200">
          <option value="">--</option>
        </select>
      </div>
    </div>

    <!-- √î nh·∫≠p t√™n nh√¢n vi√™n -->
    <div>
      <label class="block mb-1 font-semibold text-gray-700">T√™n nh√¢n vi√™n</label>
      <input type="text" id="name" oninput="updateSalary()"
        class="w-full border border-gray-300 p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-300"
        placeholder="Nh·∫≠p t√™n nh√¢n vi√™n...">
    </div>
  </div>

  <!-- K·∫øt qu·∫£ b·∫£ng l∆∞∆°ng -->
  <div id="salary-result" class="max-w-4xl mx-auto p-4 space-y-6 mt-6"></div>

  <script>
    async function updateBatchesAndSalary() {
      const month = document.getElementById('month').value;
      const year = document.getElementById('year').value;
      const batchSelect = document.getElementById('batch');

      if (!month || !year) return;

      const res = await fetch(`/api/pay-periods?month=${month}&year=${year}`);
      const data = await res.json();

      batchSelect.innerHTML = '<option value="">--</option>';
      data.forEach(b => {
        const opt = document.createElement('option');
        opt.value = b;
        opt.textContent = `ƒê·ª£t ${b}`;
        batchSelect.appendChild(opt);
      });

      updateSalary();
    }

    async function updateSalary() {
      const month = document.getElementById('month').value;
      const year = document.getElementById('year').value;
      const batch = document.getElementById('batch').value;
      const name = document.getElementById('name').value.toLowerCase();

      if (!month || !year || !batch || !name) {
        document.getElementById('salary-result').innerHTML = '';
        return;
      }

      const res = await fetch(`/api/salary?month=${month}&year=${year}&batch=${batch}&name=${encodeURIComponent(name)}`);
      const data = await res.json();

      const el = document.getElementById('salary-result');

      if (!data || !data.salary) {
        el.innerHTML = `<div class="text-red-500">Kh√¥ng t√¨m th·∫•y b·∫£ng l∆∞∆°ng</div>`;
        return;
      }

      const s = data.salary.salaryDetails;

      el.innerHTML = `
      <details class="border rounded-xl shadow bg-green-50 overflow-hidden">
        <summary class="cursor-pointer px-4 py-4 bg-green-100 font-bold text-lg flex justify-between items-center">
          <span>T·ªïng thu nh·∫≠p ƒë·ª£t n√†y</span>
          <span class="text-green-700 text-xl font-bold">${(s.actualcost || 0).toLocaleString()}‚Ç´</span>
        </summary>
        <div class="px-4 py-3 text-gray-700 border-t text-sm flex justify-between">
          <span>Kh·∫•u tr·ª´</span>
          <span class="text-red-500 font-semibold">-${(s.tax || 0).toLocaleString()}‚Ç´</span>
        </div>
      </details>

      <div class="columns-1 sm:columns-2 gap-4 space-y-4 mt-4">
        <details class="break-inside-avoid border rounded-xl shadow bg-white overflow-hidden">
          <summary class="px-4 py-3 bg-blue-100 font-semibold flex justify-between items-center">
            <span>Hoa h·ªìng & truy thu</span>
            <span class="text-green-600 font-bold">${((s.commission || 0) + (s.extracommission || 0)).toLocaleString()}‚Ç´</span>
          </summary>
          <div class="px-4 py-2 text-sm text-gray-700 border-t space-y-1">
            <div class="flex justify-between"><span>Hoa h·ªìng</span><span>${(s.commission || 0).toLocaleString()}‚Ç´</span></div>
            <div class="flex justify-between"><span>Truy thu</span><span>${(s.extracommission || 0).toLocaleString()}‚Ç´</span></div>
          </div>
        </details>

        <details class="break-inside-avoid border rounded-xl shadow bg-white overflow-hidden">
          <summary class="px-4 py-3 bg-blue-100 font-semibold flex justify-between items-center">
            <span>Ch√≠nh s√°ch th√π lao</span>
            <span class="text-green-600 font-bold">${((s.compensation || 0) + (s.extrasalary || 0)).toLocaleString()}‚Ç´</span>
          </summary>
          <div class="px-4 py-2 text-sm text-gray-700 border-t space-y-1">
            <div class="flex justify-between"><span>Ch√≠nh s√°ch</span><span>${(s.compensation || 0).toLocaleString()}‚Ç´</span></div>
            <div class="flex justify-between"><span>Truy thu</span><span>${(s.extrasalary || 0).toLocaleString()}‚Ç´</span></div>
          </div>
        </details>

        <details class="break-inside-avoid border rounded-xl shadow bg-white overflow-hidden">
          <summary class="px-4 py-3 bg-blue-100 font-semibold flex justify-between items-center">
            <span>Khen th∆∞·ªüng & h·ªó tr·ª£</span>
            <span class="text-green-600 font-bold">${((s.ebonusTCTy || 0) + (s.ebonusCT || 0) + (s.ebonusTCTy1 || 0) + (s.ebonusCT1 || 0)).toLocaleString()}‚Ç´</span>
          </summary>
          <div class="px-4 py-2 text-sm text-gray-700 border-t space-y-1">
            <div class="flex justify-between"><span>Khen th∆∞·ªüng</span><span>${(s.ebonusTCTy || 0).toLocaleString()}‚Ç´</span></div>
            <div class="flex justify-between"><span>H·ªó tr·ª£</span><span>${(s.ebonusCT || 0).toLocaleString()}‚Ç´</span></div>
            <div class="flex justify-between"><span>Khen th∆∞·ªüng 1</span><span>${(s.ebonusTCTy1 || 0).toLocaleString()}‚Ç´</span></div>
            <div class="flex justify-between"><span>H·ªó tr·ª£ 1</span><span>${(s.ebonusCT1 || 0).toLocaleString()}‚Ç´</span></div>
          </div>
        </details>

        <details class="break-inside-avoid border rounded-xl shadow bg-white overflow-hidden">
          <summary class="px-4 py-3 bg-blue-100 font-semibold flex justify-between items-center">
            <span>Kho·∫£n chi</span>
            <span class="text-red-500 font-bold">-${((s.payout1 || 0) + (s.payout2 || 0) + (s.payout3 || 0) + (s.payout4 || 0) + (s.payout5 || 0) + (s.payout6 || 0)).toLocaleString()}‚Ç´</span>
          </summary>
          <div class="px-4 py-2 text-sm text-gray-700 border-t space-y-1">
            <div class="flex justify-between"><span>Chi 1</span><span>${(s.payout1 || 0).toLocaleString()}‚Ç´</span></div>
            <div class="flex justify-between"><span>Chi 2</span><span>${(s.payout2 || 0).toLocaleString()}‚Ç´</span></div>
            <div class="flex justify-between"><span>Chi 3</span><span>${(s.payout3 || 0).toLocaleString()}‚Ç´</span></div>
            <div class="flex justify-between"><span>Chi 4</span><span>${(s.payout4 || 0).toLocaleString()}‚Ç´</span></div>
            <div class="flex justify-between"><span>Chi 5</span><span>${(s.payout5 || 0).toLocaleString()}‚Ç´</span></div>
            <div class="flex justify-between"><span>Chi 6</span><span>${(s.payout6 || 0).toLocaleString()}‚Ç´</span></div>
          </div>
        </details>
      </div>
    `;
    }

    window.addEventListener('DOMContentLoaded', updateBatchesAndSalary);
  </script>